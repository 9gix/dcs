Transaction

-- DDL Statement --

CREATE TABLE IF NOT EXISTS cart (
    id INT PRIMARY KEY AUTO_INCREMENT,
    buyer_id INT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    modified_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_completed BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (buyer_id) REFERENCES auth_user(id)
);

DROP TABLE IF EXISTS cart;

-- Query Statement --

-> Gets list of cart items in a specific cart
SELECT ci.id, ci.object_id, m.name, m.price
FROM cart_item ci, multimedia m 
WHERE ci.object_id = m.id AND
      ci.cart_id = %s

-> Gets total price of the list of cart items obtained above
SELECT ci.id, sum(m.price) as total
FROM cart_item ci, multimedia m 
WHERE ci.object_id = m.id AND
      ci.cart_id = %s

-> Gets the most recently created cart for this user
SELECT c1.id 
FROM cart c1
WHERE c1.buyer_id = %s AND
     c1.is_completed = false AND
     c1.created_at >= ALL (SELECT c2.created_at FROM cart c2);

-> Deletes an item in the cart_item
DELETE FROM cart_item 
WHERE cart_id = %s AND 
      object_id = %s

